<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quick Plot - GPS Logger</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* Base Styles */
        body {
            font-family: sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 70px;
            box-sizing: border-box;
            min-height: calc(100vh - 70px);
        }
        #plotScreen.container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 20px;
        }
        #plotTop {
            flex-shrink: 0;
        }
        h2 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }
        
        /* Live Preview Readability */
        #livePreview {
            background-color: #e9f7ff;
            border: 1px solid #b3e0ff;
            padding: 25px 15px;
            margin: 40px 0 10px; 
            border-radius: 8px;
            text-align: center;
            font-size: 1.4em;
            line-height: 1.6;
            font-weight: bold;
            color: #0056b3;
            white-space: pre-wrap;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Status Message Style */
        #statusMessage {
            text-align: center; 
            color: #d9534f; 
            font-weight: 600;
            margin-top: 10px; 
            margin-bottom: 5px; 
        }
        
        #plotBottom {
            flex-shrink: 0;
            margin-top: auto;
        }

        /* QUICK ACTION BUTTONS STYLES */
        .quick-actions {
            display: flex;
            justify-content: space-between;
            margin: 15px 0 0;
            gap: 10px; 
        }
        .quick-actions button {
            flex: 1; 
            padding: 15px 5px; 
            font-size: 1em;
            color: white; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
            font-weight: bold;
        }
        .quick-actions button:hover {
            opacity: 0.8;
        }
        
        /* Custom Colors */
        #quickHazard {
            background-color: #ff9800; /* Orange */
        }
        #quickVessel {
            background-color: #e91e63; /* Magenta */
        }
        #quickWildlife {
            background-color: #2196f3; /* Blue */
        }
        
        .quick-actions button.active {
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.7), 0 0 0 6px rgba(0, 0, 0, 0.2); 
            opacity: 1;
        }

        /* LOG Button Style */
        #logButton {
            width: 100%;
            padding: 18px 15px;
            font-size: 1.3em;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px; 
        }
        #logButton:hover {
            background-color: #218838;
        }
        
        /* Navigation Bar (Tabs) Styles */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            height: 60px;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            border-top: 1px solid #eee;
        }
        .tab-button {
            flex-grow: 1;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1em;
            color: #6c757d;
            transition: color 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px 0;
        }
        .tab-button.active {
            color: #007bff;
            font-weight: bold;
        }
        
        /* History Screen Styles */
        .history-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 0 20px;
        }
        .clear-all-btn {
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .export-csv-btn {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        .log-entry {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .log-entry input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-weight: bold;
        }
        .log-details {
            white-space: pre-wrap;
            margin-bottom: 10px;
            line-height: 1.6;
            text-align: center;
        }
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            margin-top: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .action-buttons button {
            padding: 8px 12px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .share-btn {
            background-color: #ffc107;
            color: #333;
        }
        .delete-btn {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="appContent">
        <div id="plotScreen" class="container">
            <div id="plotTop">
                <h2>Quick Plot</h2>
            </div>
            <div id="livePreview">Loading...</div>

            <p id="statusMessage" style="text-align: center; color: #d9534f;"></p>
            
            <div id="plotBottom">
                <div class="quick-actions">
                    <button id="quickHazard" data-title="HAZARD SIGHTING">HAZARD</button>
                    <button id="quickVessel" data-title="VESSEL REPORT">VESSEL</button>
                    <button id="quickWildlife" data-title="WILDLIFE SIGHTING">WILDLIFE</button>
                </div>
                <button id="logButton">LOG</button>
            </div>
        </div>
        <div id="historyScreen" style="display: none;">
            <div class="container" style="padding-top: 0;">
                <h2>History</h2>
                <div class="history-controls">
                    <button id="exportCSVButton" class="export-csv-btn">üìä Export CSV</button> 
                    <button id="clearAllButton" class="clear-all-btn">üóëÔ∏è Clear All Logs</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>
    <div class="tab-bar">
        <button class="tab-button active" data-tab="plotScreen">üß≠ Plot</button>
        <button class="tab-button" data-tab="historyScreen">üìö History</button>
    </div>
<script>
    const logButton = document.getElementById('logButton');
    const statusMessage = document.getElementById('statusMessage');
    const livePreviewDiv = document.getElementById('livePreview');
    const historyListDiv = document.getElementById('historyList');
    const clearAllButton = document.getElementById('clearAllButton');
    const exportCSVButton = document.getElementById('exportCSVButton');
    const plotScreen = document.getElementById('plotScreen');
    const historyScreen = document.getElementById('historyScreen');
    const tabButtons = document.querySelectorAll('.tab-button');
    const quickActionButtons = document.querySelectorAll('.quick-actions button');
    
    let selectedQuickTitle = 'Untitled Log';

    const STORAGE_KEY = 'simpleTimeLogs';
    let currentPositionData = {
        time: 'Loading...',
        location: 'Waiting for GPS signal...'
    };

    function showTab(screenId) {
        plotScreen.style.display = 'none';
        historyScreen.style.display = 'none';

        if (screenId === 'historyScreen') {
            historyScreen.style.display = 'block';
            renderLogs();
        } else {
            plotScreen.style.display = 'flex';
        }

        tabButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === screenId);
        });
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            showTab(button.dataset.tab);
        });
    });

    function loadLogs() {
        const json = localStorage.getItem(STORAGE_KEY);
        return json ? JSON.parse(json) : [];
    }

    function saveLogs(logs) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    }

    function deleteLog(id) {
        if (confirm('Are you sure you want to delete this log entry?')) {
            let logs = loadLogs();
            logs = logs.filter(log => log.id !== id);
            saveLogs(logs);
            renderLogs();
        }
    }

    function clearAllLogs() {
        if (confirm('WARNING: This will permanently delete ALL saved logs. Are you sure?')) {
            localStorage.removeItem(STORAGE_KEY);
            renderLogs();
        }
    }

    function toDMM(decimal, isLat) {
        const absDecimal = Math.abs(decimal);
        const degrees = Math.floor(absDecimal);
        const minutes = (absDecimal - degrees) * 60;
        let direction = isLat ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
        return `${degrees}¬∞ ${minutes.toFixed(3)}' ${direction}`;
    }

    function formatCurrentTime(now) {
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        let timezone = '';
        try {
            timezone = new Intl.DateTimeFormat(undefined, { timeZoneName: 'short' }).format(now).split(' ')[1];
        } catch {
            timezone = 'Local Time';
        }
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds} ${timezone}`;
    }

    function updateLivePreview() {
        const now = new Date();
        const timeString = formatCurrentTime(now);
        currentPositionData.time = timeString;
        livePreviewDiv.innerHTML = `${currentPositionData.time}<br>${currentPositionData.location}`;
    }

    function startLocationWatch() {
        if (!navigator.geolocation) {
            currentPositionData.location = 'Geolocation is not supported.';
            return;
        }
        navigator.geolocation.watchPosition(
            (position) => {
                const latDMM = toDMM(position.coords.latitude, true);
                const longDMM = toDMM(position.coords.longitude, false);
                currentPositionData.decimalLatitude = position.coords.latitude;
                currentPositionData.decimalLongitude = position.coords.longitude;
                currentPositionData.location = `${latDMM}\n${longDMM}`;
            },
            (error) => {
                let message = "Unknown GPS error.";
                if (error.code === error.PERMISSION_DENIED) message = "Location access denied.";
                else if (error.code === error.POSITION_UNAVAILABLE) message = "Location unavailable.";
                else if (error.code === error.TIMEOUT) message = "GPS search timed out.";
                currentPositionData.location = `GPS Error: ${message}`;
                console.error("Watch Position Error:", error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 5000
            }
        );
    }
    
    function setLogTitle(title, buttonElement) {
        selectedQuickTitle = title;
        statusMessage.textContent = `Ready to log: ${title}`;
        
        quickActionButtons.forEach(btn => btn.classList.remove('active'));
        if (buttonElement) {
            buttonElement.classList.add('active');
        }
    }

    function logCurrentData() {
        if (currentPositionData.location.startsWith('Waiting for') || currentPositionData.location.startsWith('GPS Error')) {
            statusMessage.textContent = 'Wait for a valid GPS fix before logging.';
            return;
        }
        logButton.disabled = true;
        statusMessage.textContent = 'Logging entry...';

        const newLog = {
            id: Date.now(),
            title: selectedQuickTitle,
            timestamp: currentPositionData.time,
            location: currentPositionData.location,
            lat_decimal: currentPositionData.decimalLatitude,
            lon_decimal: currentPositionData.decimalLongitude,
            note: ''
        };

        const logs = loadLogs();
        logs.unshift(newLog);
        saveLogs(logs);

        statusMessage.textContent = 'Entry logged!';
        logButton.disabled = false;
        
        // Reset the title selection after logging
        setLogTitle('Untitled Log', null);
    }

    function updateLogProperty(id, property, value) {
        const logs = loadLogs();
        const logIndex = logs.findIndex(log => log.id === id);
        if (logIndex !== -1) {
            logs[logIndex][property] = value;
            saveLogs(logs);
        }
    }

    async function shareLogNative(id) {
        if (!navigator.share) {
            alert('Your device/browser does not support native sharing. Please update or use Chrome/Samsung Internet.');
            return;
        }

        const logs = loadLogs();
        const log = logs.find(log => log.id === id);
        if (!log) return;
        
        // Format log text for sharing
        const shareText = 
            `--- Quick Plot Log Report ---\n` +
            `Title: ${log.title}\n` +
            `Time: ${log.timestamp}\n` +
            `DMM: ${log.location.replace(/\n/g, ' / ')}\n` +
            `DEC: ${log.lat_decimal}, ${log.lon_decimal}\n` +
            `Notes: ${log.note || 'No notes added.'}`;

        try {
            await navigator.share({
                title: `${log.title} Report`,
                text: shareText
            });
            console.log('Log shared successfully.');
        } catch (error) {
            console.error('Error sharing log:', error);
        }
    }

    function exportLogsToCSV() {
        const logs = loadLogs();
        if (logs.length === 0) {
            alert('No logs to export!');
            return;
        }

        // 7-Column CSV Header
        let csvContent = "Title,Timestamp,Location_DMM_Lat,Location_DMM_Lon,Latitude_Decimal,Longitude_Decimal,Notes\n";

        logs.forEach(log => {
            // Split DMM location string into two lines (Lat and Lon)
            const dmmLines = log.location.split('\n');
            const dmmLat = dmmLines[0] || '';
            const dmmLon = dmmLines[1] || '';

            // Clean up notes for CSV (replace quotes/newlines)
            const cleanNote = log.note ? log.note.replace(/"/g, '""').replace(/(\r\n|\n|\r)/gm, ' ') : '';
            
            // Ensure Decimal values exist
            const latDec = log.lat_decimal;
            const lonDec = log.lon_decimal;

            // Construct the CSV row
            csvContent += `"${log.title}","${log.timestamp}","${dmmLat}","${dmmLon}",${latDec},${lonDec},"${cleanNote}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        link.setAttribute("href", url);
        link.setAttribute("download", `QuickPlot_Export_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
    
    function renderLogs() {
        historyListDiv.innerHTML = '';
        const logs = loadLogs();
        if (logs.length === 0) {
            historyListDiv.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 30px;">Your log history is empty.</p>';
            return;
        }
        logs.forEach(log => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <input type="text" 
                    id="title-${log.id}" 
                    value="${log.title}" 
                    placeholder="Add a Title or Location Name..." 
                    data-id="${log.id}"
                    data-property="title"
                >
                <div class="log-details">${log.timestamp}\n${log.location}</div>
                <textarea 
                    id="note-${log.id}" 
                    placeholder="Add a note..."
                    data-id="${log.id}"
                    data-property="note"
                >${log.note}</textarea>
                <div class="action-buttons" style="margin-top: 10px;">
                    <button class="share-btn" data-id="${log.id}">üì§ Share Log</button> 
                    <button class="delete-btn" data-id="${log.id}">Delete Log</button>
                </div>
            `;
            historyListDiv.appendChild(entry);
        });
        attachEventListeners();
    }

    function attachEventListeners() {
        document.querySelectorAll('.log-entry input[type="text"], .log-entry textarea').forEach(element => {
            element.onblur = (e) => {
                const id = parseInt(e.target.dataset.id);
                const property = e.target.dataset.property;
                updateLogProperty(id, property, e.target.value);
            };
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.onclick = (e) => {
                const id = parseInt(e.target.dataset.id);
                deleteLog(id);
            };
        });
        document.querySelectorAll('.share-btn').forEach(button => {
            button.onclick = (e) => {
                const id = parseInt(e.target.dataset.id);
                shareLogNative(id);
            };
        });
        
        quickActionButtons.forEach(button => {
            button.onclick = (e) => {
                setLogTitle(button.dataset.title, button);
            };
        });
    }

    clearAllButton.addEventListener('click', clearAllLogs);
    exportCSVButton.addEventListener('click', exportLogsToCSV);
    logButton.addEventListener('click', logCurrentData);

    setLogTitle(selectedQuickTitle, null);

    startLocationWatch();
    setInterval(updateLivePreview, 1000);
    showTab('plotScreen');

    // ADDED: PWA Service Worker Registration for OFFLINE support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js').then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, function(err) {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
</script>
</body>
</html>
